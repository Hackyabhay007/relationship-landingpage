<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORUPhones Crash Analytics - v243</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-900">Crash Analytics</h1>
                    <div class="text-sm text-gray-600">Version: 243</div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8">
            <!-- Loading State -->
            <div id="loadingIndicator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl">
                    <div class="flex items-center space-x-3">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                        <p>Loading crash data...</p>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-sm font-medium text-gray-500">Total Crashes</h3>
                    <p id="totalCrashes" class="mt-2 text-3xl font-bold text-gray-900">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-sm font-medium text-gray-500">Affected Devices</h3>
                    <p id="affectedDevices" class="mt-2 text-3xl font-bold text-gray-900">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-sm font-medium text-gray-500">Most Common Crash</h3>
                    <p id="commonCrash" class="mt-2 text-lg font-semibold text-gray-900">-</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-sm font-medium text-gray-500">Most Affected Model</h3>
                    <p id="affectedModel" class="mt-2 text-lg font-semibold text-gray-900">-</p>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Filters</h2>
                    <div class="flex space-x-2">
                        <button id="clearFilters" class="px-3 py-1 text-sm text-gray-600 hover:text-gray-800">
                            Clear Filters
                        </button>
                        <button id="saveFilters" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                            Save Filters
                        </button>
                    </div>
                </div>
                <form id="filterForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Make</label>
                        <select id="makeFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="">All Makes</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Model</label>
                        <select id="modelFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="">All Models</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Android Version</label>
                        <select id="androidVersionFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="">All Versions</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Build Type</label>
                        <select id="buildTypeFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="">All Types</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Date Range</label>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="date" id="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <input type="date" id="endDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                    </div>
                    <div class="col-span-3">
                        <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Apply Filters
                        </button>
                    </div>
                </form>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Crashes by Android Version</h3>
                    <div class="h-64">
                        <canvas id="androidVersionChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Crashes by Device Make</h3>
                    <div class="h-64">
                        <canvas id="deviceMakeChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Daily Crash Trend</h3>
                    <div class="h-64">
                        <canvas id="crashTrendChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Error Types</h3>
                    <div class="h-64">
                        <canvas id="errorTypesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Crash Logs Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-lg font-semibold">Crash Logs</h2>
                    <button id="exportData" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Export to CSV
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Device</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Android</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Build</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Error</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                            </tr>
                        </thead>
                        <tbody id="crashLogsTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <div class="px-6 py-4 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex space-x-2">
                            <button id="prevPage" class="px-3 py-1 border rounded text-sm">Previous</button>
                            <button id="nextPage" class="px-3 py-1 border rounded text-sm">Next</button>
                        </div>
                        <div>
                            Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Crash Details Modal -->
    <div id="crashModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-4xl w-full m-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-xl font-semibold">Crash Details</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div id="crashModalContent"></div>
            </div>
        </div>
    </div>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDkScL3YbS_2UTsz6oZVm3CtOLuunceg4g",
            authDomain: "oru-phones.firebaseapp.com",
            databaseURL: "https://oru-phones-default-rtdb.firebaseio.com",
            projectId: "oru-phones",
            storageBucket: "oru-phones.firebasestorage.app",
            messagingSenderId: "510935460460",
            appId: "1:510935460460:web:a479e894b98db7af56cdd9",
            measurementId: "G-53QDJTVN1E"
        };
    
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    
        let allCrashData = [];
        let currentPage = 1;
        const ITEMS_PER_PAGE = 20;
        let filters = {
            make: '',
            model: '',
            androidVersion: '',
            buildType: '',
            startDate: '',
            endDate: ''
        };
    
        window.onload = function() {
            fetchCrashData();
            document.getElementById('filterForm').onsubmit = applyFilters;
            document.getElementById('clearFilters').onclick = clearFilters;
            document.getElementById('nextPage').onclick = nextPage;
            document.getElementById('prevPage').onclick = prevPage;
        };
    
        async function fetchCrashData() {
            showLoading();
            try {
                const snapshot = await db.collection('crash_logs').get();
                allCrashData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateFilterOptions();
                updateDashboard();
            } catch (error) {
                console.error("Error fetching data:", error);
                alert("Error loading crash data.");
            } finally {
                hideLoading();
            }
        }
    
        function populateFilterOptions() {
            const makes = new Set(allCrashData.map(log => log.deviceDetails?.make).filter(make => make));
            const models = new Set(allCrashData.map(log => log.deviceDetails?.model).filter(model => model));
            const androidVersions = new Set(allCrashData.map(log => log.deviceDetails?.androidVersion).filter(version => version));
            const buildTypes = new Set(allCrashData.map(log => log.appDetails?.buildType).filter(type => type));
    
            fillSelectOptions('makeFilter', makes);
            fillSelectOptions('modelFilter', models);
            fillSelectOptions('androidVersionFilter', androidVersions);
            fillSelectOptions('buildTypeFilter', buildTypes);
        }
    
        function fillSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">All</option>';
            options.forEach(option => {
                select.innerHTML += `<option value="${option}">${option}</option>`;
            });
        }
    
        function applyFilters(e) {
            e.preventDefault();
            filters.make = document.getElementById('makeFilter').value;
            filters.model = document.getElementById('modelFilter').value;
            filters.androidVersion = document.getElementById('androidVersionFilter').value;
            filters.buildType = document.getElementById('buildTypeFilter').value;
            filters.startDate = document.getElementById('startDate').value;
            filters.endDate = document.getElementById('endDate').value;
            currentPage = 1;
            updateDashboard();
        }
    
        function clearFilters() {
            document.getElementById('filterForm').reset();
            filters.make = '';
            filters.model = '';
            filters.androidVersion = '';
            filters.buildType = '';
            filters.startDate = '';
            filters.endDate = '';
            updateDashboard();
        }
    
        function updateDashboard() {
            const filteredData = applyFilter(allCrashData);
            renderCrashTable(filteredData);
            updateStatistics(filteredData);
            updateCharts(filteredData);
        }
    
        function applyFilter(data) {
            return data.filter(log => {
                const matchesMake = filters.make ? log.deviceDetails?.make === filters.make : true;
                const matchesModel = filters.model ? log.deviceDetails?.model === filters.model : true;
                const matchesAndroidVersion = filters.androidVersion ? log.deviceDetails?.androidVersion === filters.androidVersion : true;
                const matchesBuildType = filters.buildType ? log.appDetails?.buildType === filters.buildType : true;
    
                const logDate = log.timestamp?.seconds ? new Date(log.timestamp.seconds * 1000) : new Date(log.timestamp);
                const withinStartDate = filters.startDate ? logDate >= new Date(filters.startDate) : true;
                const withinEndDate = filters.endDate ? logDate <= new Date(filters.endDate) : true;
    
                return matchesMake && matchesModel && matchesAndroidVersion && matchesBuildType && withinStartDate && withinEndDate;
            });
        }
    
        function renderCrashTable(data) {
            const tbody = document.getElementById('crashLogsTableBody');
            tbody.innerHTML = '';
    
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageData = data.slice(start, end);
    
            pageData.forEach(crash => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${formatDate(crash.timestamp)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${crash.deviceDetails?.make} ${crash.deviceDetails?.model}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${crash.deviceDetails?.androidVersion || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${crash.appDetails?.buildType}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${crash.crashDetails?.type || 'Unknown'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="showCrashDetails('${crash.id}')" class="text-blue-600 hover:text-blue-900">
                            View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
    
            updatePagination(data.length);
        }
    
        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
    
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }
    
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
            return date.toLocaleString();
        }
    
        function nextPage() {
            const totalPages = Math.ceil(allCrashData.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                updateDashboard();
            }
        }
    
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                updateDashboard();
            }
        }
    
        function showCrashDetails(id) {
            const crash = allCrashData.find(log => log.id === id);
            if (crash) {
                const modalContent = `
                    <div>
                        <h3 class="text-lg font-semibold">Crash Information</h3>
                        <p><strong>Timestamp:</strong> ${formatDate(crash.timestamp)}</p>
                        <p><strong>Device:</strong> ${crash.deviceDetails?.make} ${crash.deviceDetails?.model}</p>
                        <p><strong>Android Version:</strong> ${crash.deviceDetails?.androidVersion}</p>
                        <p><strong>Build Type:</strong> ${crash.appDetails?.buildType}</p>
                        <p><strong>Error Type:</strong> ${crash.crashDetails?.type}</p>
                    </div>
                `;
                document.getElementById('crashModalContent').innerHTML = modalContent;
                document.getElementById('crashModal').classList.remove('hidden');
            }
        }
    
        function closeModal() {
            document.getElementById('crashModal').classList.add('hidden');
        }
    
        function updateCharts(data) {
            // Update charts based on the filtered data
            // Implementation here can use Chart.js to populate charts
        }
    
        function showLoading() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }
    
        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }
    
        // Here, you can implement the CSV export function if necessary.
        function exportToCSV() {
            // Implementation for exporting data to CSV
        }

        // Add this function to your existing JavaScript
function updateStatistics(data) {
    // Update total crashes
    document.getElementById('totalCrashes').textContent = data.length;

    // Update affected devices count
    const uniqueDevices = new Set(
        data.map(log => `${log.deviceDetails?.make || ''} ${log.deviceDetails?.model || ''}`.trim())
            .filter(device => device)
    );
    document.getElementById('affectedDevices').textContent = uniqueDevices.size;

    // Find most common crash type
    const crashTypes = data.reduce((acc, log) => {
        const type = log.crashDetails?.type || 'Unknown';
        acc[type] = (acc[type] || 0) + 1;
        return acc;
    }, {});
    const mostCommonCrash = Object.entries(crashTypes)
        .sort((a, b) => b[1] - a[1])[0];
    document.getElementById('commonCrash').textContent = 
        mostCommonCrash ? `${mostCommonCrash[0]} (${mostCommonCrash[1]})` : 'None';

    // Find most affected model
    const modelCounts = data.reduce((acc, log) => {
        const model = `${log.deviceDetails?.make || ''} ${log.deviceDetails?.model || ''}`.trim();
        if (model) {
            acc[model] = (acc[model] || 0) + 1;
        }
        return acc;
    }, {});
    const mostAffectedModel = Object.entries(modelCounts)
        .sort((a, b) => b[1] - a[1])[0];
    document.getElementById('affectedModel').textContent = 
        mostAffectedModel ? `${mostAffectedModel[0]} (${mostAffectedModel[1]})` : 'None';
}

// Update the charts function with actual implementation
function updateCharts(data) {
    // Android Version Distribution
    const androidVersions = data.reduce((acc, log) => {
        const version = log.deviceDetails?.androidVersion || 'Unknown';
        acc[version] = (acc[version] || 0) + 1;
        return acc;
    }, {});

    const androidVersionChart = new Chart(
        document.getElementById('androidVersionChart').getContext('2d'),
        {
            type: 'pie',
            data: {
                labels: Object.keys(androidVersions),
                datasets: [{
                    data: Object.values(androidVersions),
                    backgroundColor: [
                        '#4F46E5', '#10B981', '#F59E0B', '#EF4444',
                        '#6366F1', '#8B5CF6', '#EC4899', '#14B8A6'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        }
    );

    // Device Make Distribution
    const deviceMakes = data.reduce((acc, log) => {
        const make = log.deviceDetails?.make || 'Unknown';
        acc[make] = (acc[make] || 0) + 1;
        return acc;
    }, {});

    const deviceMakeChart = new Chart(
        document.getElementById('deviceMakeChart').getContext('2d'),
        {
            type: 'bar',
            data: {
                labels: Object.keys(deviceMakes),
                datasets: [{
                    label: 'Crashes by Device Make',
                    data: Object.values(deviceMakes),
                    backgroundColor: '#4F46E5'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        }
    );

    // Crash Trend Over Time
    const crashesByDate = data.reduce((acc, log) => {
        const date = new Date(log.timestamp?.seconds * 1000 || log.timestamp)
            .toISOString().split('T')[0];
        acc[date] = (acc[date] || 0) + 1;
        return acc;
    }, {});

    const sortedDates = Object.keys(crashesByDate).sort();

    const crashTrendChart = new Chart(
        document.getElementById('crashTrendChart').getContext('2d'),
        {
            type: 'line',
            data: {
                labels: sortedDates,
                datasets: [{
                    label: 'Daily Crashes',
                    data: sortedDates.map(date => crashesByDate[date]),
                    borderColor: '#4F46E5',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        }
    );

    // Error Types Distribution
    const errorTypes = data.reduce((acc, log) => {
        const type = log.crashDetails?.type || 'Unknown';
        acc[type] = (acc[type] || 0) + 1;
        return acc;
    }, {});

    const errorTypesChart = new Chart(
        document.getElementById('errorTypesChart').getContext('2d'),
        {
            type: 'doughnut',
            data: {
                labels: Object.keys(errorTypes),
                datasets: [{
                    data: Object.values(errorTypes),
                    backgroundColor: [
                        '#EF4444', '#F59E0B', '#10B981', '#6366F1',
                        '#8B5CF6', '#EC4899', '#14B8A6', '#4F46E5'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        }
    );
}

// Update the updateDashboard function
function updateDashboard() {
    const filteredData = applyFilter(allCrashData);
    updateStatistics(filteredData);
    renderCrashTable(filteredData);
    updateCharts(filteredData);
}

// Add CSV export functionality
function exportToCSV() {
    const filteredData = applyFilter(allCrashData);
    const csvContent = [
        // CSV Headers
        ['Timestamp', 'Device Make', 'Device Model', 'Android Version', 'Build Type', 'Error Type', 'Stack Trace'].join(','),
        // CSV Data
        ...filteredData.map(log => [
            formatDate(log.timestamp),
            log.deviceDetails?.make || '',
            log.deviceDetails?.model || '',
            log.deviceDetails?.androidVersion || '',
            log.appDetails?.buildType || '',
            log.crashDetails?.type || '',
            `"${(log.crashDetails?.stackTrace || '').replace(/"/g, '""')}"` // Escape quotes in stack trace
        ].join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `crash_logs_export_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

    </script>
    </body>
    </html>
    